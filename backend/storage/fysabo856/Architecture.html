<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Fitness Application – System Architecture</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Font -->
    <link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Mermaid -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide"></script>
    <style>
        :root {
            --color-primary: #1a1a2e;
            --color-accent: #00ffcc;
            --color-bg: #f5f5f5;
            --color-card-bg: #ffffff;
            --color-text: #212121;
            --color-muted: #666666;
            --font-stack: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: var(--font-stack);
            background: var(--color-bg);
            color: var(--color-text);
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        header {
            background: var(--color-primary);
            color: #fff;
            padding: 1rem 2rem;
            text-align: center;
        }
        header h1 {
            font-weight: 700;
            font-size: 1.8rem;
        }
        main {
            flex: 1;
            width: 90%;
            max-width: 1200px;
            margin: 2rem auto;
        }
        section {
            margin-bottom: 2.5rem;
        }
        h2 {
            color: var(--color-primary);
            font-weight: 600;
            margin-bottom: 1rem;
            border-left: 4px solid var(--color-accent);
            padding-left: 0.5rem;
        }
        .overview p {
            font-size: 1rem;
            color: var(--color-muted);
        }
        .diagram .mermaid {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 1rem;
            overflow: auto;
        }
        .components .component-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 1rem;
        }
        .component-card {
            background: var(--color-card-bg);
            border-left: 4px solid var(--color-accent);
            border-radius: 6px;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .component-card h3 {
            font-size: 1.1rem;
            color: var(--color-primary);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }
        .component-card p {
            font-size: 0.94rem;
            color: var(--color-muted);
            margin: 0;
            flex-grow: 1;
        }
        footer {
            background: var(--color-primary);
            color: #fff;
            text-align: center;
            padding: 1rem;
            position: relative;
        }
        .logo {
            font-size: 1.2rem;
            font-weight: 600;
            background: linear-gradient(90deg, var(--color-accent), #00aaff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        /* Print Styles */
        @media print {
            body { background: #fff; color: #000; }
            header, footer { background: none; color: #000; }
            .component-card { box-shadow: none; border: 1px solid #000; }
            .diagram .mermaid { border: none; }
        }
    </style>
</head>
<body>
    <header>
        <h1>Fitness Application – System Architecture</h1>
    </header>
    <main>
        <section class="overview">
            <h2>Architecture Overview</h2>
            <p>A high‑level, open‑source architecture for the Fitness Application that incorporates OAuth 2.0/OIDC with PKCE, Zero‑Trust networking, consent management, FHIR‑based health data exchange, immutable audit logging, feature‑flag driven consent scopes, offline‑first sync, and on‑device federated learning for personalized coaching.</p>
        </section>

        <section class="diagram">
            <h2>System Diagram</h2>
            <div class="mermaid">
graph TD
    %% Mobile client
    A[React Native / Flutter Mobile App] -->|API Calls| B[API Gateway (Kong / Envoy)]

    %% Authentication & Zero‑Trust
    B --> C[Auth Service (Keycloak OIDC with PKCE)]
    C --> D[Identity Provider (Google, Apple, Email)]

    %% Consent & User Profile
    B --> E[Consent Management Service]
    B --> F[User Profile Service]

    %% Data ingestion & storage
    B --> G[Sync Service (BLE → CRDT Buffer)]
    G --> H[FHIR Server (HAPI FHIR)]
    H --> I[(PostgreSQL for FHIR)]
    H --> J[(MongoDB for unstructured logs)]

    %% Event bus & audit
    B --> K[Event Bus (Kafka)]
    K --> L[Immutable Audit Log (Kafka + Log Compaction)]

    %% AI / Feature flags
    B --> M[Feature Flag Service (Unleash)]
    B --> N[AI Recommendation Engine (TensorFlow Federated)]

    %% External integrations
    B --> O[Third‑Party Services (Payment, Email/SMS)]

    %% Relationships
    E --> M
    N --> K
    M --> K
            </div>
        </section>

        <section class="components">
            <h2>Component Breakdown</h2>
            <div class="component-list">
                <div class="component-card">
                    <h3><i data-lucide="smartphone"></i>React Native / Flutter Mobile App</h3>
                    <p>Cross‑platform native client providing UI, BLE scanning, local‑first sync, and on‑device federated‑learning inference.</p>
                </div>
                <div class="component-card">
                    <h3><i data-lucide="gateway"></i>API Gateway (Kong / Envoy)</h3>
                    <p>Zero‑Trust entry point that performs TLS 1.3 termination, token introspection, rate‑limiting, and routing to backend microservices.</p>
                </div>
                <div class="component-card">
                    <h3><i data-lucide="shield"></i>Auth Service (Keycloak OIDC with PKCE)</h3>
                    <p>Handles OAuth 2.0 Authorization Code Flow with PKCE, MFA, and integrates with external IdPs (Google, Apple).</p>
                </div>
                <div class="component-card">
                    <h3><i data-lucide="file-check-2"></i>Consent Management Service</h3>
                    <p>Generates, encrypts (AES‑256‑GCM), stores, and versions consent receipts per ISO/IEC 29184; exposes consent‑filtered scopes to downstream services.</p>
                </div>
                <div class="component-card">
                    <h3><i data-lucide="user"></i>User Profile Service</h3>
                    <p>Stores minimal user metadata (UUID, locale, device IDs) in PostgreSQL; encrypted at rest via KMS.</p>
                </div>
                <div class="component-card">
                    <h3><i data-lucide="bluetooth"></i>Sync Service (BLE → CRDT Buffer)</h3>
                    <p>Manages BLE GATT connections, buffers sensor data locally using CRDTs, transforms measurements into FHIR Observation resources.</p>
                </div>
                <div class="component-card">
                    <h3><i data-lucide="database"></i>FHIR Server (HAPI FHIR)</h3>
                    <p>Open‑source HL7 FHIR 4 server that persists health observations; provides standardized APIs for AI and analytics.</p>
                </div>
                <div class="component-card">
                    <h3><i data-lucide="server"></i>PostgreSQL (FHIR Store)</h3>
                    <p>Relational store for structured FHIR resources, encrypted at rest and audited.</p>
                </div>
                <div class="component-card">
                    <h3><i data-lucide="file-text"></i>MongoDB (Unstructured Logs)</h3>
                    <p>Stores large‑scale immutable audit events and raw sensor blobs; data is append‑only and replicated.</p>
                </div>
                <div class="component-card">
                    <h3><i data-lucide="git-branch"></i>Event Bus (Kafka)</h3>
                    <p>High‑throughput, durable event streaming platform for consent changes, sensor data, and AI model updates; uses log compaction for immutable audit trails.</p>
                </div>
                <div class="component-card">
                    <h3><i data-lucide="list"></i>Immutable Audit Log (Kafka + Log Compaction)</h3>
                    <p>Append‑only event store that satisfies HIPAA audit‑trail requirements and supports forensic queries.</p>
                </div>
                <div class="component-card">
                    <h3><i data-lucide="toggle-left"></i>Feature Flag Service (Unleash)</h3>
                    <p>Controls conditional feature enablement based on consent scopes, subscription tier, and A/B testing.</p>
                </div>
                <div class="component-card">
                    <h3><i data-lucide="brain"></i>AI Recommendation Engine (TensorFlow Federated)</h3>
                    <p>On‑device federated‑learning pipeline that generates personalized workout plans while sending only model weight updates to the cloud.</p>
                </div>
                <div class="component-card">
                    <h3><i data-lucide="shopping-bag"></i>Third‑Party Services (Payment, Email/SMS)</h3>
                    <p>External integrations for subscription billing, email verification, and SMS OTP, accessed via the API gateway.</p>
                </div>
            </div>
        </section>
    </main>
    <footer>
        <div class="logo">AICOE</div>
        <div style="font-size:0.85rem; margin-top:0.4rem;">© 2024 AICOE – All Rights Reserved</div>
    </footer>

    <script>
        // Initialize Mermaid with custom theme variables
        mermaid.initialize({
            startOnLoad: true,
            theme: 'base',
            themeVariables: {
                primaryColor: '#1a1a2e',
                primaryTextColor: '#ffffff',
                primaryBorderColor: '#00ffcc',
                lineColor: '#00ffcc',
                nodeBorder: '#00ffcc',
                nodeBackground: '#1a1a2e',
                fontFamily: '-apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif'
            }
        });

        // Initialize Lucide icons
        lucide.createIcons();
    </script>
</body>
</html>